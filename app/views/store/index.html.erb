<% if params[:purchased] == "true" %>
<script>
  // Vanilla JS popup - runs on page load (Turbo disabled for checkout)
  window.onload = function() {
    alert("üéâ ¬°COMPRA EXITOSA! üéâ\n\nOrden: <%= params[:order] %>\nTotal: S/ <%= params[:total] %>\n\n¬°Gracias por tu compra!\nPronto recibir√°s tus productos Gloria.");
  };
</script>
<% end %>

<div class="page-header">
  <h1 class="page-title">ü•õ Productos L√°cteos Gloria</h1>
  <p class="page-subtitle">Los mejores productos l√°cteos del Per√∫</p>
</div>

<div class="search-filters">
  <%= form_with url: root_path, method: :get, local: true, data: { turbo: false } do |f| %>
    <%= text_field_tag :search, params[:search], placeholder: "üîç Buscar productos...", class: "search-input" %>
    
    <%= select_tag :category_id, 
        options_from_collection_for_select(@categories, :id, :name, params[:category_id]),
        include_blank: "üìÇ Todas las categor√≠as",
        class: "filter-select",
        onchange: "this.form.submit()" %>
    
    <%= submit_tag "Buscar", class: "btn btn-primary" %>
  <% end %>
</div>

<% if @products.any? %>
  <div class="products-grid">
    <% @products.each do |product| %>
      <div class="card<%= ' out-of-stock' if product.unavailable_for_sale? %>" style="<%= 'opacity: 0.5; filter: grayscale(100%);' if product.unavailable_for_sale? %>">
        <a href="<%= store_product_path(product) %>" style="text-decoration: none; color: inherit;">
        <div class="card-image" style="position: relative;">
          <% if product.image.attached? %>
            <%= image_tag product.image, style: "width: 100%; height: 200px; object-fit: cover;" %>
          <% elsif product.image_url.present? %>
            <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width: 100%; height: 200px; object-fit: cover;">
          <% else %>
            üßÄ
          <% end %>
          <% if product.batch_expired? %>
            <div style="position: absolute; top: 10px; right: 10px; background: #8B0000; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
              ‚ö†Ô∏è VENCIDO
            </div>
          <% elsif product.out_of_stock? %>
            <div style="position: absolute; top: 10px; right: 10px; background: var(--gloria-danger); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
              AGOTADO
            </div>
          <% end %>
        </div>
        
        <div class="card-body">
          <h3 class="card-title"><%= product.name %></h3>
          <p class="card-text">
            <small>üìÇ <%= product.category&.name || "Sin categor√≠a" %></small>
          </p>
          <p class="card-text"><%= truncate(product.description, length: 80) %></p>
          <p class="card-price">S/ <%= number_with_precision(product.price, precision: 2) %></p>
          <p style="font-size: 0.85rem; color: <%= product.unavailable_for_sale? ? 'var(--gloria-danger)' : 'var(--gloria-success)' %>; font-weight: bold;">
            <% if product.batch_expired? %>
              ‚ö†Ô∏è Producto vencido - No disponible
            <% elsif product.out_of_stock? %>
              ‚ùå Sin stock
            <% else %>
              ‚úì <%= product.stock %> unidades disponibles
            <% end %>
          </p>
        </div>
        </a>
        
        <div class="card-footer">
          <% if product.unavailable_for_sale? %>
            <button class="btn btn-secondary" style="width: 100%; cursor: not-allowed;" disabled>
              <% if product.batch_expired? %>‚ö†Ô∏è Vencido<% else %>‚ùå Agotado<% end %>
            </button>
          <% else %>
            <%= link_to "üëÅÔ∏è Ver detalle", store_product_path(product), class: "btn btn-primary", style: "width: 100%;" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-state">
    <div class="empty-state-icon">ü•õ</div>
    <h3 class="empty-state-title">No hay productos disponibles</h3>
    <p>Pronto tendremos m√°s productos l√°cteos para ti.</p>
  </div>
<% end %>
